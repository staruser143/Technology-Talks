Perfect üí° ‚Äî adding **conditional inclusion** turns your PDF generation framework into a *true dynamic document assembly engine* ‚Äî where pages (or sections) are included only when certain JSON-based conditions are met.

Let‚Äôs enhance the system step by step üëá

---

## üß© 1Ô∏è‚É£ YAML Specification (with conditional logic)

We extend the `pages` section with a new `includeIf` property.

```yaml
document:
  name: "ApplicantBundle"
  description: "Combined applicant document"
  output: "output/final_bundle.pdf"

pages:
  - name: "ApplicantForm"
    type: "acroform"
    template: "templates/applicant_form.pdf"
    mapping: "config/mapping_applicant.yaml"

  - name: "SpouseSummary"
    type: "freemarker"
    template: "templates/spouse_summary.ftl"
    mapping: "config/mapping_spouse.yaml"
    includeIf: "$.applicantList[?(@.relationship == 'Spouse')]"  # Only include if spouse exists

  - name: "DependentSummary"
    type: "freemarker"
    template: "templates/dependent_summary.ftl"
    mapping: "config/mapping_dependents.yaml"
    includeIf: "$.applicantList[?(@.relationship == 'Child')]"   # Include only if dependents exist

  - name: "Annexure"
    type: "pdf"
    template: "templates/annexure.pdf"
    merge: true
```

---

## üß© 2Ô∏è‚É£ Update `PageSpec.java`

Add the conditional inclusion expression:

```java
package com.example.pdfgen.config;

public class PageSpec {
    private String name;
    private String type; // acroform, freemarker, pdf
    private String template;
    private String mapping;
    private boolean merge;
    private String includeIf; // NEW: condition expression

    public String getName() { return name; }
    public void setName(String name) { this.name = name; }

    public String getType() { return type; }
    public void setType(String type) { this.type = type; }

    public String getTemplate() { return template; }
    public void setTemplate(String template) { this.template = template; }

    public String getMapping() { return mapping; }
    public void setMapping(String mapping) { this.mapping = mapping; }

    public boolean isMerge() { return merge; }
    public void setMerge(boolean merge) { this.merge = merge; }

    public String getIncludeIf() { return includeIf; }
    public void setIncludeIf(String includeIf) { this.includeIf = includeIf; }
}
```

---

## üß© 3Ô∏è‚É£ Add JSONPath evaluation utility

We‚Äôll use [Jayway JsonPath](https://github.com/json-path/JsonPath) (lightweight and fast) to evaluate conditions.

### Maven dependency

```xml
<dependency>
  <groupId>com.jayway.jsonpath</groupId>
  <artifactId>json-path</artifactId>
  <version>2.9.0</version>
</dependency>
```

### `JsonConditionEvaluator.java`

```java
package com.example.pdfgen.util;

import com.fasterxml.jackson.databind.JsonNode;
import com.jayway.jsonpath.JsonPath;
import com.jayway.jsonpath.Configuration;
import com.jayway.jsonpath.ReadContext;

import java.util.List;

public class JsonConditionEvaluator {

    public static boolean evaluate(String condition, JsonNode jsonData) {
        if (condition == null || condition.trim().isEmpty()) {
            return true; // No condition means always include
        }

        try {
            Object document = Configuration.defaultConfiguration().jsonProvider().parse(jsonData.toString());
            ReadContext ctx = JsonPath.parse(document);
            Object result = ctx.read(condition);

            if (result instanceof List) {
                return !((List<?>) result).isEmpty(); // True if any match
            }
            if (result instanceof Boolean) {
                return (Boolean) result;
            }
            return result != null;
        } catch (Exception e) {
            System.err.println("‚ö†Ô∏è Condition evaluation failed for: " + condition);
            e.printStackTrace();
            return false;
        }
    }
}
```

---

## üß© 4Ô∏è‚É£ Update `UnifiedDocumentProcessor.java`

Add conditional check before processing a page:

```java
package com.example.pdfgen.processor;

import com.example.pdfgen.config.DocumentSpec;
import com.example.pdfgen.config.PageSpec;
import com.example.pdfgen.util.YamlDocumentLoader;
import com.example.pdfgen.util.JsonConditionEvaluator;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.pdfbox.multipdf.PDFMergerUtility;

import java.io.File;
import java.util.ArrayList;
import java.util.List;

public class UnifiedDocumentProcessor {

    private final AcroFormProcessor acroProcessor = new AcroFormProcessor();
    private final FreemarkerHtmlProcessor htmlProcessor = new FreemarkerHtmlProcessor();
    private final ObjectMapper mapper = new ObjectMapper();

    public void generate(String docSpecPath, String jsonDataPath) throws Exception {
        DocumentSpec docSpec = YamlDocumentLoader.load(docSpecPath);
        JsonNode jsonData = mapper.readTree(new File(jsonDataPath));

        List<File> generatedPdfs = new ArrayList<>();

        for (PageSpec page : docSpec.getPages()) {
            // ‚úÖ Conditional inclusion
            if (!JsonConditionEvaluator.evaluate(page.getIncludeIf(), jsonData)) {
                System.out.println("‚è≠Ô∏è Skipping page: " + page.getName() + " (condition not met)");
                continue;
            }

            File templateFile = new File(page.getTemplate());
            File tempOutput = File.createTempFile(page.getName(), ".pdf");

            switch (page.getType().toLowerCase()) {
                case "acroform":
                    acroProcessor.fillForm(templateFile, new File(jsonDataPath), new File(page.getMapping()), tempOutput);
                    generatedPdfs.add(tempOutput);
                    break;

                case "freemarker":
                    htmlProcessor.generatePdf(templateFile, new File(jsonDataPath), new File(page.getMapping()), tempOutput);
                    generatedPdfs.add(tempOutput);
                    break;

                case "pdf":
                    if (page.isMerge()) {
                        generatedPdfs.add(templateFile);
                    }
                    break;

                default:
                    throw new IllegalArgumentException("Unknown page type: " + page.getType());
            }
        }

        mergePdfs(generatedPdfs, new File(docSpec.getDocument().getOutput()));
    }

    private void mergePdfs(List<File> pdfFiles, File outputFile) throws Exception {
        PDFMergerUtility merger = new PDFMergerUtility();
        merger.setDestinationFileName(outputFile.getAbsolutePath());
        for (File f : pdfFiles) {
            merger.addSource(f);
        }
        merger.mergeDocuments(null);
        System.out.println("‚úÖ Final merged PDF generated at: " + outputFile.getAbsolutePath());
    }
}
```

---

## üß© 5Ô∏è‚É£ Example Behavior

With this setup:

* **ApplicantForm** is *always* included.
* **SpouseSummary** is included **only if** there‚Äôs a spouse in `applicantList`.
* **DependentSummary** is included **only if** there‚Äôs at least one child.
* **Annexure** (existing PDF) is *always merged*.

If the input JSON has no spouse or dependents, the final bundle will only include the form and annexure.

---

## üß© 6Ô∏è‚É£ Example Input JSON

```json
{
  "applicantList": [
    { "relationship": "Primary", "fname": "John", "lname": "Doe" },
    { "relationship": "Child", "fname": "Sara", "lname": "Doe" }
  ]
}
```

‚û°Ô∏è Only ‚ÄúApplicantForm‚Äù, ‚ÄúDependentSummary‚Äù, and ‚ÄúAnnexure‚Äù will appear.

---

## ‚úÖ Benefits of Conditional Inclusion

| Feature                           | Benefit                                                            |
| --------------------------------- | ------------------------------------------------------------------ |
| **Dynamic assembly**              | Include or skip sections based on data                             |
| **Declarative logic**             | No code changes, logic in YAML                                     |
| **Reusable conditions**           | JSONPath lets you query any nested structure                       |
| **Works with all template types** | Freemarker, AcroForm, or pre-existing PDFs                         |
| **Extensible**                    | Could support `includeUnless`, or complex boolean conditions later |

---

## üîß Next Possible Enhancements

Would you like me to:

1. Add **templated expressions** (e.g., `includeIf: "${applicantList.size() > 1}"`) using a lightweight expression evaluator like MVEL or Spring Expression Language (SpEL)?
2. Add **page-level variable scoping**, so that each page automatically receives only the relevant slice of JSON data (e.g., spouse data for spouse page)?

Both make the YAML much more powerful and business-friendly.

Would you like me to extend it to include those capabilities next?
