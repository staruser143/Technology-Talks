<mxfile>
  <diagram name="Agent Signature Workflow" type="device">
    <mxGraphModel dx="1252" dy="648" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        
        <!-- Kafka Topic -->
        <mxCell value="Kafka Topic&#10;All Applications" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1" x="100" y="100" width="160" height="80"/>
        
        <!-- Service Bus Queue -->
        <mxCell value="Azure Service Bus Queue&#10;agent-signature-requests" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1" x="100" y="220" width="180" height="80"/>
        
        <!-- Logic App Trigger -->
        <mxCell value="Logic App Triggered&#10;One instance per message" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d9ead3;strokeColor=#83af9b;" vertex="1" parent="1" x="100" y="340" width="180" height="80"/>
        
        <!-- Parse Message -->
        <mxCell value="Parse Message&#10;applicationId, agentEmail" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#cfe2f3;strokeColor=#6d94c0;" vertex="1" parent="1" x="100" y="460" width="160" height="60"/>
        
        <!-- Send Email -->
        <mxCell value="Send Signature Request Email&#10;with link to web portal" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#cfe2f3;strokeColor=#6d94c0;" vertex="1" parent="1" x="100" y="560" width="180" height="60"/>
        
        <!-- Wait for Callback -->
        <mxCell value="Wait for HTTP Callback&#10;State preserved (up to 12 days)" style="shape=hexagon;whiteSpace=wrap;html=1;fillColor=#d2e8ff;strokeColor=#1c75bc;" vertex="1" parent="1" x="100" y="660" width="180" height="70"/>
        
        <!-- Agent Clicks Link -->
        <mxCell value="Agent Clicks Link&#10;https://your-portal.com?app=APP-123" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe599;strokeColor=#d6b656;" vertex="1" parent="1" x="400" y="100" width="200" height="60"/>
        
        <!-- Web Portal -->
        <mxCell value="Custom Web Portal&#10;Azure Static Web App" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d9e8f5;strokeColor=#6c8ebf;" vertex="1" parent="1" x="400" y="190" width="180" height="60"/>
        
        <!-- Show Form -->
        <mxCell value="Show Signature Form&#10;Canvas or accept button" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d9e8f5;strokeColor=#6c8ebf;" vertex="1" parent="1" x="400" y="280" width="180" height="60"/>
        
        <!-- Agent Submits -->
        <mxCell value="Agent Signs &amp; Submits" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d9e8f5;strokeColor=#6c8ebf;" vertex="1" parent="1" x="400" y="370" width="180" height="50"/>
        
        <!-- Azure Function -->
        <mxCell value="Azure Function API&#10;POST /api/sign" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#a2c4e0;strokeColor=#204a87;" vertex="1" parent="1" x="400" y="450" width="160" height="50"/>
        
        <!-- Save to DB -->
        <mxCell value="Save Signature to DB&#10;e.g., MongoDB Atlas" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#a2c4e0;strokeColor=#204a87;" vertex="1" parent="1" x="400" y="530" width="180" height="50"/>
        
        <!-- Call Callback -->
        <mxCell value="Call Logic App&#10;Callback URL" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#a2c4e0;strokeColor=#204a87;" vertex="1" parent="1" x="400" y="610" width="160" height="50"/>
        
        <!-- Resume Logic App -->
        <mxCell value="Logic App Resumes" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#b6d7a8;strokeColor=#6aa84f;" vertex="1" parent="1" x="100" y="760" width="160" height="50"/>
        
        <!-- Validate -->
        <mxCell value="Validate Signature Data" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#cfe2f3;strokeColor=#6d94c0;" vertex="1" parent="1" x="100" y="840" width="160" height="50"/>
        
        <!-- Continue Processing -->
        <mxCell value="Continue Processing&#10;Create account, notify HR" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#cfe2f3;strokeColor=#6d94c0;" vertex="1" parent="1" x="100" y="920" width="180" height="50"/>
        
        <!-- Update Status -->
        <mxCell value="Update Status:&#10;COMPLETED" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#9fc5e8;strokeColor=#3c78d8;" vertex="1" parent="1" x="100" y="1000" width="160" height="50"/>
        
        <!-- Workflow Ends -->
        <mxCell value="Workflow Successfully Ends" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#6aa84f;strokeColor=#fff;color=#fff;fontSize=12;" vertex="1" parent="1" x="100" y="1080" width="180" height="50"/>
        
        <!-- Message Removed -->
        <mxCell value="✅ Service Bus Message&#10;Automatically COMPLETED&#10;➡ Removed from Queue" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#38761d;strokeColor=#fff;color=#fff;fontSize=12;" vertex="1" parent="1" x="100" y="1160" width="200" height="60"/>
        
        <!-- Timeout Path -->
        <mxCell value="No Signature in 12 Days?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#ffe599;strokeColor=#d6b656;" vertex="1" parent="1" x="300" y="700" width="80" height="80"/>
        
        <mxCell value="Yes" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1" x="380" y="730" width="40" height="20"/>
        
        <mxCell value="Timeout Triggered&#10;After P12D" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ea9999;strokeColor=#b85450;" vertex="1" parent="1" x="400" y="760" width="160" height="50"/>
        
        <mxCell value="Update Status:&#10;PENDING_APPROVAL" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ea9999;strokeColor=#b85450;" vertex="1" parent="1" x="400" y="840" width="160" height="50"/>
        
        <mxCell value="Notify Admin" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ea9999;strokeColor=#b85450;" vertex="1" parent="1" x="400" y="920" width="140" height="40"/>
        
        <!-- Arrows -->
        <mxCell edge="1" source="0" target="1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;sourcePerimeterSpacing=4;targetPerimeterSpacing=4;" parent="1" source="0" target="1"/>
        
        <!-- Kafka to SB -->
        <mxCell edge="1" parent="1" source="0" target="1" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="1" target="2" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="2" target="3" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="3" target="4" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="4" target="5" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="5" target="6" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="6" target="7" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="7" target="8" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="8" target="9" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="9" target="10" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="10" target="11" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="11" target="12" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="12" target="13" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="13" target="14" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="14" target="15" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="5" target="16" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="16" target="17" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="17" target="18" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="18" target="19" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="19" target="20" style="edgeStyle=orthogonalEdgeStyle;"/><mxCell edge="1" parent="1" source="20" target